[{"id": 0, "timestamp": "2025-05-19T19:15:47.956025", "source": "user", "message": "You are an expert NLP research scientist to help user with coding on NLP related tasks. \n    You are given a research paper named paper.pdf and an incomplete repository of the paper. You need to parse the paper with Python first and then are required to finish the user's task based on the paper and the repository.\n    If you cannot read the paper directly, you can try to write python code to parse the pdf file.\n    \n    The user's tasks include the following:0: Implement the forward function of calulating the Hyperbolic Loss in src/hierarchy_transformers/losses/hit_loss.py based on paper.pdf. \n    You are required to directly revise the python file mentioned in the instruction. You can only revise the function you need to implement. Do not revise unrelated part of the file.\n\n    Please do NOT run the program in the background.\n    If the program uses some packages that are incompatible, please figure out alternative implementations and do NOT restart the environment.\n\n    ", "action": "message", "args": {"content": "You are an expert NLP research scientist to help user with coding on NLP related tasks. \n    You are given a research paper named paper.pdf and an incomplete repository of the paper. You need to parse the paper with Python first and then are required to finish the user's task based on the paper and the repository.\n    If you cannot read the paper directly, you can try to write python code to parse the pdf file.\n    \n    The user's tasks include the following:0: Implement the forward function of calulating the Hyperbolic Loss in src/hierarchy_transformers/losses/hit_loss.py based on paper.pdf. \n    You are required to directly revise the python file mentioned in the instruction. You can only revise the function you need to implement. Do not revise unrelated part of the file.\n\n    Please do NOT run the program in the background.\n    If the program uses some packages that are incompatible, please figure out alternative implementations and do NOT restart the environment.\n\n    ", "image_urls": null, "wait_for_response": false}}, {"id": 1, "timestamp": "2025-05-19T19:15:47.967948", "source": "user", "message": "Retrieving content for: You are an expert NLP research scientist to help u", "action": "recall", "args": {"recall_type": "workspace_context", "query": "You are an expert NLP research scientist to help user with coding on NLP related tasks. \n    You are given a research paper named paper.pdf and an incomplete repository of the paper. You need to parse the paper with Python first and then are required to finish the user's task based on the paper and the repository.\n    If you cannot read the paper directly, you can try to write python code to parse the pdf file.\n    \n    The user's tasks include the following:0: Implement the forward function of calulating the Hyperbolic Loss in src/hierarchy_transformers/losses/hit_loss.py based on paper.pdf. \n    You are required to directly revise the python file mentioned in the instruction. You can only revise the function you need to implement. Do not revise unrelated part of the file.\n\n    Please do NOT run the program in the background.\n    If the program uses some packages that are incompatible, please figure out alternative implementations and do NOT restart the environment.\n\n    ", "thought": ""}}, {"id": 2, "timestamp": "2025-05-19T19:15:47.968519", "source": "environment", "message": "", "observation": "agent_state_changed", "content": "", "extras": {"agent_state": "running", "reason": ""}}, {"id": 3, "timestamp": "2025-05-19T19:15:47.968751", "source": "environment", "message": "Added workspace context", "cause": 1, "observation": "recall", "content": "Added workspace context", "extras": {"recall_type": "workspace_context", "repo_name": "", "repo_directory": "", "repo_instructions": "", "runtime_hosts": {"http://localhost:50079": 50079, "http://localhost:58511": 58511}, "additional_agent_instructions": "", "date": "2025-05-20", "microagent_knowledge": []}}, {"id": 4, "timestamp": "2025-05-19T19:15:49.486004", "source": "agent", "message": "Running command: ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_bAefLo1PuUIGzK9t2tE8F89R", "model_response": {"id": "chatcmpl-BZ4w0PH862wYtwvHHFGkhy00SQgG0", "created": 1747700148, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf\"}", "name": "execute_bash"}, "id": "call_bAefLo1PuUIGzK9t2tE8F89R", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 42, "prompt_tokens": 4124, "total_tokens": 4166, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 3968}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.0026320000000000002, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 4124, "completion_tokens": 42, "cache_read_tokens": 3968, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 5, "timestamp": "2025-05-19T19:15:50.137062", "source": "agent", "message": "Command `ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf` executed with exit code 2.", "cause": 4, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_bAefLo1PuUIGzK9t2tE8F89R", "model_response": {"id": "chatcmpl-BZ4w0PH862wYtwvHHFGkhy00SQgG0", "created": 1747700148, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf\"}", "name": "execute_bash"}, "id": "call_bAefLo1PuUIGzK9t2tE8F89R", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 42, "prompt_tokens": 4124, "total_tokens": 4166, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 3968}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "total 4\ndrwxr-xr-x 3 root root 4096 May 20 00:15 benchmark\nls: cannot access '/workspace/src/hierarchy_transformers/losses': No such file or directory", "extras": {"command": "ls -l /workspace && ls -l /workspace/src/hierarchy_transformers/losses && ls -l /workspace/paper.pdf", "metadata": {"exit_code": 2, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 2.]"}, "hidden": false}, "success": false}, {"id": 6, "timestamp": "2025-05-19T19:15:51.048462", "source": "agent", "message": "Running command: find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_1aRoNoIq1Ewpu5spVonT5uok", "model_response": {"id": "chatcmpl-BZ4w2VaV6ODlS9r5XnTP3tizpcIWv", "created": 1747700150, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'\"}", "name": "execute_bash"}, "id": "call_1aRoNoIq1Ewpu5spVonT5uok", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 40, "prompt_tokens": 4282, "total_tokens": 4322, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4096}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.005372, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 8406, "completion_tokens": 82, "cache_read_tokens": 8064, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 7, "timestamp": "2025-05-19T19:15:51.683838", "source": "agent", "message": "Command `find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'` executed with exit code 0.", "cause": 6, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_1aRoNoIq1Ewpu5spVonT5uok", "model_response": {"id": "chatcmpl-BZ4w2VaV6ODlS9r5XnTP3tizpcIWv", "created": 1747700150, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'\"}", "name": "execute_bash"}, "id": "call_1aRoNoIq1Ewpu5spVonT5uok", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 40, "prompt_tokens": 4282, "total_tokens": 4322, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4096}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf\n/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "extras": {"command": "find /workspace -type f -name 'paper.pdf' && find /workspace -type f -name 'hit_loss.py'", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}, {"id": 8, "timestamp": "2025-05-19T19:15:53.863974", "source": "agent", "message": "Running command: ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_lCvGfCbWsvM4Uir37yIIvDg7", "model_response": {"id": "chatcmpl-BZ4w4N1yUCR8dUuC9jNh4IOmutBOU", "created": 1747700152, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py\"}", "name": "execute_bash"}, "id": "call_lCvGfCbWsvM4Uir37yIIvDg7", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 71, "prompt_tokens": 4438, "total_tokens": 4509, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4224}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.00848, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 12844, "completion_tokens": 153, "cache_read_tokens": 12288, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 9, "timestamp": "2025-05-19T19:15:54.503072", "source": "agent", "message": "Command `ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py` executed with exit code 0.", "cause": 8, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_lCvGfCbWsvM4Uir37yIIvDg7", "model_response": {"id": "chatcmpl-BZ4w4N1yUCR8dUuC9jNh4IOmutBOU", "created": 1747700152, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py\"}", "name": "execute_bash"}, "id": "call_lCvGfCbWsvM4Uir37yIIvDg7", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 71, "prompt_tokens": 4438, "total_tokens": 4509, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4224}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "total 28\n-rw-r--r-- 1 root root 1181 May 20 00:15 __init__.py\ndrwxr-xr-x 2 root root 4096 May 20 00:15 __pycache__\n-rw-r--r-- 1 root root 5275 May 20 00:15 hit_loss.py\n-rw-r--r-- 1 root root 6293 May 20 00:15 hyper_cone_loss.py\n-rw-r--r-- 1 root root 2046 May 20 00:15 poincare_embed_loss.py\n# Copyright 2023 Yuan He\n\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n\n#     http://www.apache.org/licenses/LICENSE-2.0\n\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nfrom __future__ import annotations\n\nimport logging\nfrom collections.abc import Iterable\n\nimport torch\nimport torch.nn.functional as F\nfrom geoopt.manifolds import PoincareBall\n\nfrom hierarchy_transformers.models import HierarchyTransformer\nfrom hierarchy_transformers.utils import format_citation\n\nlogger = logging.getLogger(__name__)\n\n\nclass HierarchyTransformerLoss(torch.nn.Module):\n    \"\"\"Hyperbolic loss that linearly combines hperbolic clustering loss and hyperbolic Centripetal loss and applies weights for joint optimisation.\"\"\"\n\n    def __init__(\n        self,\n        model: HierarchyTransformer,\n        clustering_loss_weight: float = 1.0,\n        clustering_loss_margin: float = 5.0,\n        centripetal_loss_weight: float = 1.0,\n        centripetal_loss_margin: float = 0.5,\n    ):\n        super().__init__()", "extras": {"command": "ls -l /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses && head -40 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}, {"id": 10, "timestamp": "2025-05-19T19:15:55.603998", "source": "agent", "message": "Running command: head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_IJbEc07E3Ur9GMoFyPs01fz9", "model_response": {"id": "chatcmpl-BZ4w6wyEhusdhE6o5ekGiFDmc9zlF", "created": 1747700154, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py\"}", "name": "execute_bash"}, "id": "call_IJbEc07E3Ur9GMoFyPs01fz9", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 44, "prompt_tokens": 5013, "total_tokens": 5057, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4480}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.012138, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 17857, "completion_tokens": 197, "cache_read_tokens": 16768, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 11, "timestamp": "2025-05-19T19:15:56.232565", "source": "agent", "message": "Command `head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py` executed with exit code 0.", "cause": 10, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_IJbEc07E3Ur9GMoFyPs01fz9", "model_response": {"id": "chatcmpl-BZ4w6wyEhusdhE6o5ekGiFDmc9zlF", "created": 1747700154, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py\"}", "name": "execute_bash"}, "id": "call_IJbEc07E3Ur9GMoFyPs01fz9", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 44, "prompt_tokens": 5013, "total_tokens": 5057, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 4480}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "# Copyright 2023 Yuan He\n\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n\n#     http://www.apache.org/licenses/LICENSE-2.0\n\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nfrom __future__ import annotations\n\nimport logging\nfrom collections.abc import Iterable\n\nimport torch\nimport torch.nn.functional as F\nfrom geoopt.manifolds import PoincareBall\n\nfrom hierarchy_transformers.models import HierarchyTransformer\nfrom hierarchy_transformers.utils import format_citation\n\nlogger = logging.getLogger(__name__)\n\n\nclass HierarchyTransformerLoss(torch.nn.Module):\n    \"\"\"Hyperbolic loss that linearly combines hperbolic clustering loss and hyperbolic Centripetal loss and applies weights for joint optimisation.\"\"\"\n\n    def __init__(\n        self,\n        model: HierarchyTransformer,\n        clustering_loss_weight: float = 1.0,\n        clustering_loss_margin: float = 5.0,\n        centripetal_loss_weight: float = 1.0,\n        centripetal_loss_margin: float = 0.5,\n    ):\n        super().__init__()\n\n        self.model = model\n        self.manifold = self.model.manifold\n        self.cluster_weight = clustering_loss_weight\n        self.centri_weight = centripetal_loss_weight\n        self.cluster_loss_margin = clustering_loss_margin\n        self.centri_loss_margin = centripetal_loss_margin\n\n    def forward(self, sentence_features: Iterable[dict[str, torch.Tensor]], labels: torch.Tensor):\n        \"\"\"Forward propagation that follows [`sentence_transformers.losses`](https://github.com/UKPLab/sentence-transformers/tree/master/sentence_transformers/losses).\"\"\"\n        reps = [self.model(sentence_feature)[\"sentence_embedding\"] for sentence_feature in sentence_features]\n        assert len(reps) == 3\n        rep_anchor, rep_positive, rep_negative = reps\n\n        combined_loss, cluster_loss, centri_loss = None, None, None\n\n        ### TODO: compute and combine hyperbolic clustering and centripetal losses here\n\n        return {\n            \"loss\": combined_loss,\n            \"cluster_loss\": cluster_loss,\n            \"centri_loss\": centri_loss,\n        }\n\n    @property\n    def citation(self) -> str:\n        return format_citation(\n            \"\"\"\n            @article{he2024language,\n              title={Language models as hierarchy encoders},\n              author={He, Yuan and Yuan, Zhangdie and Chen, Jiaoyan and Horrocks, Ian},\n              journal={arXiv preprint arXiv:2401.11374},\n              year={2024}\n            }\n            \"\"\"\n        )\n\n\nclass HyperbolicClusteringLoss(torch.nn.Module):\n    r\"\"\"Hyperbolic loss that clusters entities in subsumptions.", "extras": {"command": "head -80 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}, {"id": 12, "timestamp": "2025-05-19T19:15:58.071683", "source": "agent", "message": "Running command: head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_KZrXIz5oN6qPWkNbLRjTfVpq", "model_response": {"id": "chatcmpl-BZ4w8nYDfJH0f3O3gYcYjz6H2uSnF", "created": 1747700156, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py\"}", "name": "execute_bash"}, "id": "call_KZrXIz5oN6qPWkNbLRjTfVpq", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 46, "prompt_tokens": 5773, "total_tokens": 5819, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 0}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.024051999999999997, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 23630, "completion_tokens": 243, "cache_read_tokens": 16768, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 13, "timestamp": "2025-05-19T19:15:58.710034", "source": "agent", "message": "Command `head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py` executed with exit code 0.", "cause": 12, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_KZrXIz5oN6qPWkNbLRjTfVpq", "model_response": {"id": "chatcmpl-BZ4w8nYDfJH0f3O3gYcYjz6H2uSnF", "created": 1747700156, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py\"}", "name": "execute_bash"}, "id": "call_KZrXIz5oN6qPWkNbLRjTfVpq", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 46, "prompt_tokens": 5773, "total_tokens": 5819, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 0}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "# Copyright 2023 Yuan He\n\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n\n#     http://www.apache.org/licenses/LICENSE-2.0\n\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nfrom __future__ import annotations\n\nimport torch\nimport torch.nn.functional as F\nfrom geoopt.manifolds import PoincareBall\n\nfrom hierarchy_transformers.utils import format_citation\n\n\nclass HyperbolicEntailmentConeLoss(torch.nn.Module):\n    \"\"\"Hyperbolic loss that construct entailment cones for entities.\n\n    Essentially, this loss is expected to achieve:\n    $$\n        angle(child, parent_cone_axis) < angle(parent_cone)\n    $$\n\n    Inputs are labelled pairs presented in `(rep_anchor, rep_other, label)`.\n    \"\"\"\n\n    def __init__(self, manifold: PoincareBall, min_euclidean_norm: float = 0.1, margin: float = 0.1, eps: float = 1e-5):\n        super().__init__()\n        self.manifold = manifold\n        assert self.manifold.c == 1.0, f\"Entailment cone loss is not defined for curvature: {manifold.c}.\"\n        self.min_euclidean_norm = min_euclidean_norm\n        self.margin = margin\n        self.eps = eps\n\n    def get_config_dict(self):\n        config = {\"distance_metric\": \"PoincareBall(c=1.0).cone_angle\", \"margin\": self.margin}\n        return config\n\n    def half_cone_aperture(self, cone_tip: torch.Tensor):\n        \"\"\"Angle between the axis [0, x] (line through 0 and x) and the boundary of the cone at x,\n        where x is the cone tip.\n        \"\"\"\n        # cone tip means the point x is the tip of the hyperbolic cone\n        # norm_tip = cone_tip.norm(dim=-1).clamp(min=self.min_euclidean_norm)  # to prevent undefined aperture\n        sq_norm_tip = cone_tip.pow(2).sum(dim=-1).clamp(min=self.min_euclidean_norm + self.eps, max=1 - self.eps)\n        return torch.arcsin(self.min_euclidean_norm * (1 - sq_norm_tip) / torch.sqrt(sq_norm_tip)).clamp(\n            min=-1 + self.eps, max=1 - self.eps\n        )\n\n    def cone_angle_at_u(self, cone_tip: torch.Tensor, u: torch.Tensor):\n        \"\"\"Angle between the axis [0, x] and the line [x, u]. This angle should be smaller than the\n        half cone aperture at x for real children.\n        \"\"\"", "extras": {"command": "head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hyper_cone_loss.py", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}, {"id": 14, "timestamp": "2025-05-19T19:16:00.018370", "source": "agent", "message": "Running command: head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py", "action": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_05dXlXb0Nu68Ack7IlInyz3x", "model_response": {"id": "chatcmpl-BZ4wBjzNXqXVRDnk0WbEV4cQPjIPA", "created": 1747700159, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py\"}", "name": "execute_bash"}, "id": "call_05dXlXb0Nu68Ack7IlInyz3x", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 46, "prompt_tokens": 6530, "total_tokens": 6576, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 5760}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.028839999999999998, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 30160, "completion_tokens": 289, "cache_read_tokens": 22528, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"command": "head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py", "is_input": false, "thought": "", "blocking": false, "hidden": false, "confirmation_state": "confirmed"}}, {"id": 15, "timestamp": "2025-05-19T19:16:00.657742", "source": "agent", "message": "Command `head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py` executed with exit code 0.", "cause": 14, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "call_05dXlXb0Nu68Ack7IlInyz3x", "model_response": {"id": "chatcmpl-BZ4wBjzNXqXVRDnk0WbEV4cQPjIPA", "created": 1747700159, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py\"}", "name": "execute_bash"}, "id": "call_05dXlXb0Nu68Ack7IlInyz3x", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 46, "prompt_tokens": 6530, "total_tokens": 6576, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 5760}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "# Copyright 2023 Yuan He\n\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n\n#     http://www.apache.org/licenses/LICENSE-2.0\n\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nfrom __future__ import annotations\n\nimport torch\nfrom geoopt.manifolds import PoincareBall\n\nfrom hierarchy_transformers.utils import format_citation\n\n\nclass PoincareEmbeddingStaticLoss(torch.nn.Module):\n    \"\"\"Poincare embedding loss.\n\n    Essentially, this loss is expected to achieve:\n\n    $$d(child, parent) < d(child, negative)$$\n\n    Inputs are presented in `(subject, *objects)` where the first `object` is positive and the rest are negative.\n\n    This is designed for the static embedding implementation.\n    \"\"\"\n\n    def __init__(self, manifold: PoincareBall):\n        super().__init__()\n        self.manifold = manifold\n        self.cross_entropy = torch.nn.CrossEntropyLoss()\n\n    def forward(self, subject: torch.Tensor, objects: torch.Tensor):\n        # first object is always the correct one\n        pred_dists = self.manifold.dist(subject, objects)\n        correct_object_indices = torch.tensor([0] * len(pred_dists)).to(pred_dists.device)\n        return self.cross_entropy(-pred_dists, correct_object_indices)\n\n    @property\n    def citation(self) -> str:\n        return format_citation(\n            \"\"\"\n            @article{nickel2017poincare,\n              title={Poincar{\\'e} embeddings for learning hierarchical representations},\n              author={Nickel, Maximillian and Kiela, Douwe},\n              journal={Advances in neural information processing systems},\n              volume={30},\n              year={2017}\n            }\n            \"\"\"\n        )", "extras": {"command": "head -60 /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/poincare_embed_loss.py", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "1f9027277da0", "working_dir": "/workspace/benchmark/datasets", "py_interpreter_path": "/openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}, {"id": 16, "timestamp": "2025-05-19T19:16:01.711930", "source": "agent", "message": "Reading file: /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf", "action": "read", "tool_call_metadata": {"function_name": "str_replace_editor", "tool_call_id": "call_to7sYrluBeH7g9Tr6GB7PdXQ", "model_response": {"id": "chatcmpl-BZ4wCb9oUfmnGBnOIihDTYMwohl48", "created": 1747700160, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"view\",\"path\":\"/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf\"}", "name": "str_replace_editor"}, "id": "call_to7sYrluBeH7g9Tr6GB7PdXQ", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 36, "prompt_tokens": 7085, "total_tokens": 7121, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 6528}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.033505999999999994, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 37245, "completion_tokens": 325, "cache_read_tokens": 29056, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"path": "/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf", "start": 0, "end": -1, "thought": "", "impl_source": "oh_aci", "view_range": null}}, {"id": 17, "timestamp": "2025-05-19T19:16:01.733779", "source": "agent", "message": "ERROR_BINARY_FILE", "cause": 16, "observation": "error", "tool_call_metadata": {"function_name": "str_replace_editor", "tool_call_id": "call_to7sYrluBeH7g9Tr6GB7PdXQ", "model_response": {"id": "chatcmpl-BZ4wCb9oUfmnGBnOIihDTYMwohl48", "created": 1747700160, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"view\",\"path\":\"/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf\"}", "name": "str_replace_editor"}, "id": "call_to7sYrluBeH7g9Tr6GB7PdXQ", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 36, "prompt_tokens": 7085, "total_tokens": 7121, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 6528}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "ERROR_BINARY_FILE", "extras": {"error_id": ""}}, {"id": 18, "timestamp": "2025-05-19T19:16:03.843862", "source": "agent", "message": "Running Python code interactively: import PyPDF2\n\npdf_path = '/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf'\nreader = PyPDF2.PdfReader(pdf_path)\nnum_pages = len(reader.pages)\ntext = ''\nfor i in range(min(num_pages, 10)):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])", "action": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_zk8pdVs0eD7pd2hwhlHmJAWe", "model_response": {"id": "chatcmpl-BZ4wEzi8KeCHvqa8vF5PZaIeoJW5i", "created": 1747700162, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"import PyPDF2\\n\\npdf_path = '/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf'\\nreader = PyPDF2.PdfReader(pdf_path)\\nnum_pages = len(reader.pages)\\ntext = ''\\nfor i in range(min(num_pages, 10)):\\n    text += reader.pages[i].extract_text() + '\\\\n'\\nprint(text[:2000])\"}", "name": "execute_ipython_cell"}, "id": "call_zk8pdVs0eD7pd2hwhlHmJAWe", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 103, "prompt_tokens": 7142, "total_tokens": 7245, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7040}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.03805399999999999, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 44387, "completion_tokens": 428, "cache_read_tokens": 36096, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"code": "import PyPDF2\n\npdf_path = '/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf'\nreader = PyPDF2.PdfReader(pdf_path)\nnum_pages = len(reader.pages)\ntext = ''\nfor i in range(min(num_pages, 10)):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])", "thought": "", "include_extra": true, "confirmation_state": "confirmed", "kernel_init_code": ""}}, {"id": 19, "timestamp": "2025-05-19T19:16:04.134500", "source": "agent", "message": "Code executed in IPython cell.", "cause": 18, "observation": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_zk8pdVs0eD7pd2hwhlHmJAWe", "model_response": {"id": "chatcmpl-BZ4wEzi8KeCHvqa8vF5PZaIeoJW5i", "created": 1747700162, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"import PyPDF2\\n\\npdf_path = '/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf'\\nreader = PyPDF2.PdfReader(pdf_path)\\nnum_pages = len(reader.pages)\\ntext = ''\\nfor i in range(min(num_pages, 10)):\\n    text += reader.pages[i].extract_text() + '\\\\n'\\nprint(text[:2000])\"}", "name": "execute_ipython_cell"}, "id": "call_zk8pdVs0eD7pd2hwhlHmJAWe", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 103, "prompt_tokens": 7142, "total_tokens": 7245, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7040}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "Language Models as Hierarchy Encoders\nYuan He\nUniversity of Oxford\nyuan.he@cs.ox.ac.ukZhangdie Yuan\nUniversity of Cambridge\nzy317@cam.ac.uk\nJiaoyan Chen\nThe University of Manchester\njiaoyan.chen@mancheser.ac.ukIan Horrocks\nUniversity of Oxford\nian.horrocks@cs.ox.ac.uk\nAbstract\nInterpreting hierarchical structures latent in language is a key limitation of current\nlanguage models (LMs). While previous research has implicitly leveraged these\nhierarchies to enhance LMs, approaches for their explicit encoding are yet to be\nexplored. To address this, we introduce a novel approach to re-train transformer\nencoder-based LMs as Hierarchy Transformer encoders ( HITs), harnessing the\nexpansive nature of hyperbolic space. Our method situates the output embedding\nspace of pre-trained LMs within a Poincar\u00e9 ball with a curvature that adapts to the\nembedding dimension, followed by training on hyperbolic clustering and centripetal\nlosses. These losses are designed to effectively cluster related entities (input as\ntexts) and organise them hierarchically. We evaluate HITs against pre-trained LMs,\nstandard fine-tuned LMs, and several hyperbolic embedding baselines, focusing\non their capabilities in simulating transitive inference, predicting subsumptions,\nand transferring knowledge across hierarchies. The results demonstrate that HITs\nconsistently outperform all baselines in these tasks, underscoring the effectiveness\nand transferability of our re-trained hierarchy encoders.1\n1 Introduction\nIn the field of Natural Language Processing (NLP) and related areas, the emergence of transformer-\nbased language models (LMs) such as BERT (encoder-based) [ 1], GPT (decoder-based) [ 2], and\nthe more recent large language models (LLMs) like GPT-4 [ 3] and Llama 2 [ 4], has marked a\nsignificant progression. Nonetheless, these models face a notable challenge in effectively encoding\nand interpreting hierarchical structures latent in language. This limitation has been highlighted by\nseveral studies, inc\n[Jupyter current working directory: /workspace/benchmark/datasets]\n[Jupyter Python interpreter: /openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python]", "extras": {"code": "import PyPDF2\n\npdf_path = '/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/paper.pdf'\nreader = PyPDF2.PdfReader(pdf_path)\nnum_pages = len(reader.pages)\ntext = ''\nfor i in range(min(num_pages, 10)):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])"}, "success": true}, {"id": 20, "timestamp": "2025-05-19T19:16:05.674441", "source": "agent", "message": "Running Python code interactively: # Extract more pages for loss details\ntext = ''\nfor i in range(10, 20):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])", "action": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_E1R8CZedkSUP5tZJ0ntEuHSp", "model_response": {"id": "chatcmpl-BZ4wGxEPsugOsTNcziey4S3ubryyK", "created": 1747700164, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"# Extract more pages for loss details\\ntext = ''\\nfor i in range(10, 20):\\n    text += reader.pages[i].extract_text() + '\\\\n'\\nprint(text[:2000])\"}", "name": "execute_ipython_cell"}, "id": "call_E1R8CZedkSUP5tZJ0ntEuHSp", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 61, "prompt_tokens": 7754, "total_tokens": 7815, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7168}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.04329799999999999, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 52141, "completion_tokens": 489, "cache_read_tokens": 43264, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"code": "# Extract more pages for loss details\ntext = ''\nfor i in range(10, 20):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])", "thought": "", "include_extra": true, "confirmation_state": "confirmed", "kernel_init_code": ""}}, {"id": 21, "timestamp": "2025-05-19T19:16:06.229567", "source": "agent", "message": "Code executed in IPython cell.", "cause": 20, "observation": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_E1R8CZedkSUP5tZJ0ntEuHSp", "model_response": {"id": "chatcmpl-BZ4wGxEPsugOsTNcziey4S3ubryyK", "created": 1747700164, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"# Extract more pages for loss details\\ntext = ''\\nfor i in range(10, 20):\\n    text += reader.pages[i].extract_text() + '\\\\n'\\nprint(text[:2000])\"}", "name": "execute_ipython_cell"}, "id": "call_E1R8CZedkSUP5tZJ0ntEuHSp", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 61, "prompt_tokens": 7754, "total_tokens": 7815, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7168}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "---------------------------------------------------------------------------\nIndexError                                Traceback (most recent call last)\nCell In[1], line 4\n      2 text = ''\n      3 for i in range(10, 20):\n----> 4     text += reader.pages[i].extract_text() + '\\n'\n      5 print(text[:2000])\n\nFile /openhands/poetry/openhands-ai-5O4_aCHf-py3.12/lib/python3.12/site-packages/PyPDF2/_page.py:2077, in _VirtualList.__getitem__(self, index)\n   2075     index = len_self + index\n   2076 if index < 0 or index >= len_self:\n-> 2077     raise IndexError(\"sequence index out of range\")\n   2078 return self.get_function(index)\n\nIndexError: sequence index out of range\n[Jupyter current working directory: /workspace/benchmark/datasets]\n[Jupyter Python interpreter: /openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python]", "extras": {"code": "# Extract more pages for loss details\ntext = ''\nfor i in range(10, 20):\n    text += reader.pages[i].extract_text() + '\\n'\nprint(text[:2000])"}, "success": true}, {"id": 22, "timestamp": "2025-05-19T19:16:09.141223", "source": "agent", "message": "Running Python code interactively: # Print all available pages to find the loss function details\nnum_pages = len(reader.pages)\nprint('Total pages:', num_pages)\nfor i in range(num_pages):\n    print(f'--- Page {i+1} ---')\n    print(reader.pages[i].extract_text()[:1500])\n    print('\\n')", "action": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_C6eRS2dUtHstw5gvUvjccgJ6", "model_response": {"id": "chatcmpl-BZ4wJUG5Z36yEjkc52oOIgN7MtvMT", "created": 1747700167, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"# Print all available pages to find the loss function details\\nnum_pages = len(reader.pages)\\nprint('Total pages:', num_pages)\\nfor i in range(num_pages):\\n    print(f'--- Page {i+1} ---')\\n    print(reader.pages[i].extract_text()[:1500])\\n    print('\\\\n')\"}", "name": "execute_ipython_cell"}, "id": "call_C6eRS2dUtHstw5gvUvjccgJ6", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 88, "prompt_tokens": 8050, "total_tokens": 8138, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7808}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.04838999999999999, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 60191, "completion_tokens": 577, "cache_read_tokens": 51072, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"code": "# Print all available pages to find the loss function details\nnum_pages = len(reader.pages)\nprint('Total pages:', num_pages)\nfor i in range(num_pages):\n    print(f'--- Page {i+1} ---')\n    print(reader.pages[i].extract_text()[:1500])\n    print('\\n')", "thought": "", "include_extra": true, "confirmation_state": "confirmed", "kernel_init_code": ""}}, {"id": 23, "timestamp": "2025-05-19T19:16:09.905884", "source": "agent", "message": "Code executed in IPython cell.", "cause": 22, "observation": "run_ipython", "tool_call_metadata": {"function_name": "execute_ipython_cell", "tool_call_id": "call_C6eRS2dUtHstw5gvUvjccgJ6", "model_response": {"id": "chatcmpl-BZ4wJUG5Z36yEjkc52oOIgN7MtvMT", "created": 1747700167, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"code\":\"# Print all available pages to find the loss function details\\nnum_pages = len(reader.pages)\\nprint('Total pages:', num_pages)\\nfor i in range(num_pages):\\n    print(f'--- Page {i+1} ---')\\n    print(reader.pages[i].extract_text()[:1500])\\n    print('\\\\n')\"}", "name": "execute_ipython_cell"}, "id": "call_C6eRS2dUtHstw5gvUvjccgJ6", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 88, "prompt_tokens": 8050, "total_tokens": 8138, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 7808}}, "service_tier": "default"}, "total_calls_in_response": 1}, "content": "Total pages: 15\n--- Page 1 ---\nLanguage Models as Hierarchy Encoders\nYuan He\nUniversity of Oxford\nyuan.he@cs.ox.ac.ukZhangdie Yuan\nUniversity of Cambridge\nzy317@cam.ac.uk\nJiaoyan Chen\nThe University of Manchester\njiaoyan.chen@mancheser.ac.ukIan Horrocks\nUniversity of Oxford\nian.horrocks@cs.ox.ac.uk\nAbstract\nInterpreting hierarchical structures latent in language is a key limitation of current\nlanguage models (LMs). While previous research has implicitly leveraged these\nhierarchies to enhance LMs, approaches for their explicit encoding are yet to be\nexplored. To address this, we introduce a novel approach to re-train transformer\nencoder-based LMs as Hierarchy Transformer encoders ( HITs), harnessing the\nexpansive nature of hyperbolic space. Our method situates the output embedding\nspace of pre-trained LMs within a Poincar\u00e9 ball with a curvature that adapts to the\nembedding dimension, followed by training on hyperbolic clustering and centripetal\nlosses. These losses are designed to effectively cluster related entities (input as\ntexts) and organise them hierarchically. We evaluate HITs against pre-trained LMs,\nstandard fine-tuned LMs, and several hyperbolic embedding baselines, focusing\non their capabilities in simulating transitive inference, predicting subsumptions,\nand transferring knowledge across hierarchies. The results demonstrate that HITs\nconsistently outperform all baselines in these tasks, underscoring the effectiveness\nand transferability of our re-trained hierarchy encoders.1\n1 Introduction\nIn th\n\n\n--- Page 2 ---\nstructural representations into textual formats to align the masked language modeling objective.\nOthers, like [ 10] and [ 11], have focused on extracting analogous and contrasting examples from\nhierarchical structures for a similarity-based contrastive learning objective. The aforementioned\nstudies leveraged hierarchical information as implicit signals to augment LMs, yet no existing works\nspecifically targeted the explicit encoding of hierarchies with LMs.\nberryblueberryraspberryfruit\npccomputere-devicelaptopentity\nberryblueberryraspberryfruitlaptopcomputere-devicepcentityphonephonePre-trainedHierarchy Re-trained\nFigure 1: Illustration of how hierarchies are explic-\nitly encoded in HITs. The square ( d-dimensional\nhyper-cube) refers to the output embedding space\nof transformer encoder-based LMs whose final ac-\ntivation function is typically tanh , and the circum-\nscribed circle ( d-dimensional hyper-sphere) refers\nto the Poincar\u00e9 ball of radius\u221a\nd. The distance and\nnorm metrics involved in our hyperbolic losses are\ndefined w.r.t. this manifold.To bridge this gap, we introduce a novel ap-\nproach to re-train transformer encoder-based\nLMs as Hierarchy Transformer encoders\n(HITs). Inspired by the efficacy of hyperbolic\ngeometry in representing hierarchical structures\n[12,13], we propose the hyperbolic cluster-\ning and centripetal losses tailored for LM re-\ntraining. As illustrated in Figure 1, transformer\nencoder-based LMs typically use a tanh acti-\nvation function in the last l\n\n\n--- Page 3 ---\ntransformer encoder-based LMs maintain their importance, offering versatility and efficiency in tasks\nlike text classification and semantic search.\n2.2 Hyperbolic Geometry\nHyperbolic geometry, a form of non-Euclidean geometry, is featured by its constant negative Gaussian\ncurvature, a fundamental aspect that differentiates it from the flat, zero curvature of Euclidean\ngeometry. In hyperbolic space, distances between points increase exponentially as one moves towards\nthe boundary, making it inherently suitable for embedding hierarchical structures. This intuition\naligns with the tree embedding theorem based on \u03b4-hyperbolicity, as discussed in [23] and [13].\nAmong the various models5of hyperbolic geometry that are isometric6to each other, the Poincar\u00e9\nball is chosen for its capacity to contain the the output embedding space of LMs directly, as explained\nin the second last paragraph of Section 1. The d-dimensional Poincar\u00e9 ball with a negative curvature\n\u2212c(where c >0) is defined by the open ball Bd\nc={x\u2208Rd:\u2225x\u22252<1\nc}. The distance function in\nthis model, dependent on the curvature value c, is given by:\ndc(u,v) =2\u221actanh\u22121(\u221ac\u2225\u2212u\u2295cv\u2225) (1)\nIn this equation, u,v\u2208Bd\nc,\u2225\u00b7\u2225denotes the Euclidean norm, and \u2295cdenotes the M\u00f6bius addition\n[24] defined as:\nu\u2295cv=(1 + 2 c\u27e8u,v\u27e9+c\u2225v\u22252)u+ (1\u2212c\u2225u\u22252)v\n1 + 2 c\u27e8u,v\u27e9+c2\u2225u\u22252\u2225v\u22252(2)\nHere,\u27e8\u00b7,\u00b7\u27e9denotes the inner product in Euclidean space. Note that for flat curvature c= 0,Bd\ncwill\nbeRdand\u2295cwill be the Euclidean addition.\n2.3 Hierarchy\nWe define a hierarchy\n\n\n--- Page 4 ---\nd-dimensional hyper-cube because of the tanh activation function in the last layer. Thus, we can\nconstruct a Poincar\u00e9 ball of radius\u221a\nd(or equivalently, curvature value c=1\nd) whose boundary\ncircumscribes the hyper-cube.7Unlike previous hyperbolic embedding methods that utilise the entire\nhyperbolic space and often require a projection layer to manage out-of-manifold embeddings, our\nmethod ensures that embeddings are contained within a specific subset of this manifold. Empirical\nevidence supports that this subset sufficiently accommodates entities in high-dimensional space (see\nSection 4.5). Based on this curvature-adapted manifold, we propose the following two losses for\nhierarchy re-training.\nHyperbolic Clustering Loss This loss aims at clustering related entities and distancing unrelated\nones in the Poincar\u00e9 ball. We formulate it in the form of triplet loss because related entities are\nnot equivalent but their semantic distances should be smaller than those between unrelated entities.\nFormally, the loss is defined as:\nLcluster =X\n(e,e+,e\u2212)\u2208Dmax( dc(e,e+)\u2212dc(e,e\u2212) +\u03b1,0) (3)\nHere, inputs are presented in the form of triplet (e, e+, e\u2212), where e+is a parent entity of e, ande\u2212\nis a negative parent entity of e;Ddenotes the set of these triplets; dc(\u00b7,\u00b7)refers to the hyperbolic\ndistance function defined in Equation (1), and \u03b1is the hyperbolic distance margin. The bold letters\ndenote the embeddings of the corresponding entities.\nHyperbolic Centripetal Loss This loss ensures paren\n\n\n--- Page 5 ---\nTable 1: Statistics of WordNet (Noun), Schema.org, and FoodOn, including the numbers of entities\n(#Entity ), direct subsumptions ( #DirectSub ), indirect subsumptions ( #IndirectSub ), and the dataset\nsplittings ( #Dataset ) for Multi-hop Inference and Mixed-hop Prediction tasks. Note that the numbers\nin#Dataset are counts of entity pairs rather than entity triplets.\nSource #Entity #DirectSub #IndirectSub #Dataset (Train/Val/Test)\nWordNet 74,401 75,850 587,658multi: 834K /323K/323K\nmixed: 751K /365K/365K\nSchema.org 903 950 1,978 mixed: - /15K/15K\nFoodOn 30,963 36,486 438,266 mixed: 361K /261K/261K\nDOID 11,157 11,180 45,383 mixed: 111K /31K/31K\nand/or as the relative difference in their hyperbolic norms ( \u2225e1\u2225c\u2212 \u2225e2\u2225c) increases. Essentially, for\nthe model to predict e1\u2291e2, it is expected that e1ande2are relatively closer in the Poincar\u00e9 ball,\nwithe1positioned further from the manifold\u2019s origin compared to e2. The value for \u03bband the overall\nscoring threshold are to be ascertained through hyperparameter tuning on the validation set.\n4 Evaluation\n4.1 Task Definition\nMulti-hop Inference This task, following the setting in [ 13], aims to evaluate the model\u2019s ability\nin deducing indirect, multi-hop subsumptions Tfrom direct, one-hop subsumptions E, so as to\nsimulate transitive inference. We split Tfor validation and testing, denoted as TvalandTtest,\nrespectively. For each positive subsumption (e, e+)involved, we sampled 10negative parents e\u2212for\ne, leading to 10training triplets8. F\n\n\n--- Page 6 ---\nacross different domains, we additionally constructed datasets from ontologies that represent varied\nsemantic granularities and domains, namely Schema.org [ 16], Food Ontology (FoodOn) [ 17], and\nDisease Ontology (DOID) [ 18]. We retrieved WordNet from NLTK [25] and adopted pre-processing\nsteps similar to [ 12], utilising the hypernym relations between noun synsets to construct the hierarchy.\nFor Schema.org, FoodOn, and DOID, our pre-processing paralleled that in [ 6], transforming these\nontologies into hierarchies of named entities (details in Appendix A). To accommodate the textual\ninput requirements of LMs, we constructed an entity lexicon using the name attribute in WordNet\nand the rdfs:label property in the ontologies.9\nOn WordNet (Noun), FoodOn, and DOID, we adopt a consistent splitting ratio for the validation and\ntesting sets. Specifically, we allocate two separate 5%portions of the indirect subsumptions Tto\nformTvalandTtest, respectively. Similarly, two distinct 5%portions of the direct subsumptions E\nare used as EvalandEtest. As Schema.org is significantly smaller than the other hierarchies and only\nused for transfer evaluation, we split its entire EandTsets into halves for validation and testing,\nrespectively. Table 1 presents the extracted hierarchies\u2019 statistics and the resulting datasets for the\nMulti-hop Inference and Mixed-hop Prediction tasks.\nIn addition to our main evaluation, we constructed a dataset from the widely-recognised biomedical\nontology SNOMED CT\n\n\n--- Page 7 ---\nTable 2: Multi-hop Inference and Mixed-hop Prediction test results on WordNet.\nRandom Negatives Hard Negatives\nModel Precision Recall F-score Precision Recall F-score\nNaivePrior 0.091 0.091 0.091 0.091 0.091 0.091\nMulti-hop Inference (WordNet)\nPoincar\u00e9Embed 0.862 0.866 0.864 0.797 0.867 0.830\nHyperbolicCone 0.817 0.996 0.898 0.243 0.902 0.383\nall-MiniLM-L6-v2 0.160 0.442 0.235 0.132 0.507 0.209\n+ fine-tune 0.800 0.513 0.625 0.764 0.597 0.670\n+ H IT 0.864 0.879 0.871 0.905 0.908 0.907\nall-MiniLM-L12-v2 0.127 0.585 0.209 0.108 0.740 0.188\n+ fine-tune 0.811 0.515 0.630 0.819 0.530 0.643\n+ H IT 0.880 0.927 0.903 0.910 0.906 0.908\nall-mpnet-base-v2 0.281 0.428 0.339 0.183 0.359 0.242\n+ fine-tune 0.796 0.501 0.615 0.758 0.628 0.687\n+ H IT 0.897 0.936 0.916 0.886 0.912 0.899\nMixed-hop Prediction (WordNet)\nall-MiniLM-L6-v2 0.160 0.438 0.235 0.131 0.504 0.208\n+ fine-tune 0.747 0.575 0.650 0.769 0.578 0.660\n+ H IT 0.835 0.877 0.856 0.882 0.843 0.862\nall-MiniLM-L12-v2 0.127 0.583 0.209 0.111 0.625 0.188\n+ fine-tune 0.794 0.517 0.627 0.859 0.515 0.644\n+ H IT 0.875 0.895 0.885 0.886 0.857 0.871\nall-mpnet-base-v2 0.287 0.439 0.347 0.197 0.344 0.250\n+ fine-tune 0.828 0.536 0.651 0.723 0.622 0.669\n+ H IT 0.892 0.910 0.900 0.869 0.858 0.863\n4.4 Results\nThe effectiveness of our hierarchy re-training approach is evident from the results of both the Multi-\nhop Inference and Mixed-hop Prediction tasks on WordNet (see Table 2), as well as the Transfer\nMixed-hop Prediction task on Schema.org, FoodO\n\n\n--- Page 8 ---\nTable 3: Transfer Mixed-hop Prediction test results on Schema.org, FoodOn, and DOID.\nRandom Negatives Hard Negatives\nModel Precision Recall F-score Precision Recall F-score\nNaivePrior 0.091 0.091 0.091 0.091 0.091 0.091\nTransfer Mixed-hop Prediction (WordNet \u2192Schema.org)\nPoincar\u00e9GloVe 0.485 0.403 0.441 0.436 0.415 0.425\nall-MiniLM-L12-v2 0.312 0.524 0.391 0.248 0.494 0.330\n+ fine-tune 0.391 0.433 0.411 0.597 0.248 0.351\n+ H IT 0.503 0.613 0.553 0.408 0.583 0.480\nTransfer Mixed-hop Prediction (WordNet \u2192FoodOn)\nPoincar\u00e9GloVe 0.192 0.224 0.207 0.189 0.200 0.195\nall-MiniLM-L12-v2 0.135 0.656 0.224 0.099 0.833 0.176\n+ fine-tune 0.436 0.382 0.407 0.690 0.177 0.282\n+ H IT 0.690 0.463 0.554 0.741 0.385 0.507\nTransfer Mixed-hop Prediction (WordNet \u2192DOID)\nPoincar\u00e9GloVe 0.265 0.314 0.287 0.283 0.318 0.299\nall-MiniLM-L12-v2 0.342 0.451 0.389 0.159 0.455 0.235\n+ fine-tune 0.585 0.621 0.603 0.868 0.179 0.297\n+ H IT 0.696 0.711 0.704 0.810 0.435 0.566\nLimited Generalisation in Fine-tuned LMs The research by [ 8] illustrates that fine-tuned LMs\nperform well on single-hop subsumptions. Our observations concur, showing that fine-tuned LMs\nachieve comparable performance as HITs when assessed on just single-hop test samples. However,\ntheir effectiveness wanes when applied to arbitrary entity subsumptions. For the tasks on WordNet,\nfine-tuned LMs underperform HITs by0.194to0.301in F-scores. In the transfer task from WordNet\nto Schema.org, the fine-tuned all-MiniLM-L12-v2 model only marginally out\n\n\n--- Page 9 ---\n4.5 Analysis of H IT Embeddings\nDistribution Figure 3 illustrates how WordNet entity embeddings generated by all-MiniLM-L12-\nv2+HIT distribute w.r.t. their hyperbolic norms.\nFigure 3: Distribution of WordNet entity embed-\ndings generated by HITw.r.t. their hyperbolic\nnorms.\nTable 4: Statistical correlations between WordNet\nentities\u2019 depths and their hyperbolic norms across\ndifferent hyperbolic models.\nHIT Poincar\u00e9Embed HyperbolicCone\n0.346 0.130 0.245\nTable 5: Hyperbolic distances between the em-\nbeddings of selected entities ( \u201ccomputer\u201d ,\u201cpc\u201d ,\n\u201cfruit\u201d ,\u201cberry\u201d ), along with their individual hyper-\nbolic norms ( h-norm ) and depths in WordNet.\ncomputer pc fruit berry\ncomputer 0.0 5.9 22.5 24.9\npc 5.9 0.0 25.2 27.2\nfruit 22.5 25.2 0.0 6.72\nberry 24.9 27.2 6.72 0.0\nh-norm 17.5 19.1 15.3 16.6\ndepth 9 11 9 10These norms effectively capture the natural ex-\npansion of the hierarchical structure, evidenced\nby an exponential rise in the number of child\nentities. A notable observation is the sharp de-\ncline in the number of entities when hyperbolic\nnorms exceed 23, suggesting that few entities\nreside at these higher levels. Additionally, the\nrange of entity hyperbolic norms, approximately\nfrom 8to24, indicates that a relatively small re-\ngion of the high-dimensional manifold suffices\nto accommodate all entities in WordNet.\nCorrelation In Table 4, we compare the Pear-\nson correlation coefficients across different hy-\nperbolic models to measure the linear relation-\nship between entiti\n\n\n--- Page 10 ---\ninductive predictions about unseen data. Further explorations include learning word embeddings in\nhyperbolic space [ 31,32]. These methods, however, are limited to word-level tokenisation and yield\nnon-contextual word representations. These shortcomings can be mitigated by integrating hyperbolic\nembeddings with transformer-based LMs. [ 33] has explored this direction, applying learnable layers\nto project LM embeddings into hyperbolic space for syntax parsing and sentiment analysis. Our\napproach diverges from theirs by focusing on training LMs as general hierarchy encoders without the\nneed for additional learnable parameters.\n6 Conclusion\nThis paper tackles the challenge of enabling language models to interpret and encode hierarchies. We\ndevise the hierarchy re-training approach that involves a joint optimisation on both the hyperbolic\nclustering and hyperbolic centripetal losses, aiming to cluster and organise entities according to their\nhierarchical relationships. The resulting HITmodels demonstrate proficiency in simulating transitive\ninference and predicting subsumptions within and across hierarchies. Additionally, our analysis of\nHITembeddings highlights their geometric interpretability, further validating the effectiveness of our\napproach.\n7 Limitations and Future Work\nThis work does not address the potential loss of pre-trained language understanding resulted from\nhierarchy re-training. Also, the issue of entity naming ambiguity inherent in the dataset sources is not\nta\n\n\n--- Page 11 ---\n[7]Ruixi Lin and Hwee Tou Ng. Does bert know that the is-a relation is transitive? In Proceedings\nof the 60th Annual Meeting of the Association for Computational Linguistics (Volume 2: Short\nPapers) , pages 94\u201399, 2022.\n[8]Jiaoyan Chen, Yuan He, Yuxia Geng, Ernesto Jim\u00e9nez-Ruiz, Hang Dong, and Ian Horrocks.\nContextual semantic embeddings for ontology subsumption prediction. World Wide Web , pages\n1\u201323, 2023.\n[9]Hao Liu, Yehoshua Perl, and James Geller. Concept placement using bert trained by trans-\nforming and summarizing biomedical ontology structure. Journal of Biomedical Informatics ,\n112:103607, 2020.\n[10] Fangyu Liu, Ehsan Shareghi, Zaiqiao Meng, Marco Basaldella, and Nigel Collier. Self-alignment\npretraining for biomedical entity representations. In Proceedings of the 2021 Conference of the\nNorth American Chapter of the Association for Computational Linguistics: Human Language\nTechnologies , pages 4228\u20134238, 2021.\n[11] Francis Gosselin and Amal Zouaq. Sorbet: A siamese network for ontology embeddings using\na distance-based regression loss and bert. In International Semantic Web Conference , pages\n561\u2013578. Springer, 2023.\n[12] Maximillian Nickel and Douwe Kiela. Poincar\u00e9 embeddings for learning hierarchical represen-\ntations. Advances in neural information processing systems , 30, 2017.\n[13] Octavian Ganea, Gary B\u00e9cigneul, and Thomas Hofmann. Hyperbolic entailment cones for\nlearning hierarchical embeddings. In International Conference on Machine Learning , pages\n1646\u2013165\n\n\n--- Page 12 ---\n[24] Octavian Ganea, Gary B\u00e9cigneul, and Thomas Hofmann. Hyperbolic neural networks. Advances\nin neural information processing systems , 31, 2018.\n[25] Edward Loper and Steven Bird. Nltk: The natural language toolkit. In Proceedings of the ACL-\n02 Workshop on Effective Tools and Methodologies for Teaching Natural Language Processing\nand Computational Linguistics , pages 63\u201370, 2002.\n[26] Fabio Petroni, Tim Rockt\u00e4schel, Sebastian Riedel, Patrick Lewis, Anton Bakhtin, Yuxiang Wu,\nand Alexander Miller. Language models as knowledge bases? In Proceedings of the 2019\nConference on Empirical Methods in Natural Language Processing and the 9th International\nJoint Conference on Natural Language Processing (EMNLP-IJCNLP) , pages 2463\u20132473, 2019.\n[27] Julian Salazar, Davis Liang, Toan Q Nguyen, and Katrin Kirchhoff. Masked language model\nscoring. In Proceedings of the 58th Annual Meeting of the Association for Computational\nLinguistics , pages 2699\u20132712, 2020.\n[28] Antoine Bordes, Nicolas Usunier, Alberto Garcia-Duran, Jason Weston, and Oksana Yakhnenko.\nTranslating embeddings for modeling multi-relational data. Advances in neural information\nprocessing systems , 26, 2013.\n[29] Bishan Yang, Wen-tau Yih, Xiaodong He, Jianfeng Gao, and Li Deng. Embedding entities and\nrelations for learning and inference in knowledge bases. arXiv preprint arXiv:1412.6575 , 2014.\n[30] Jiaoyan Chen, Pan Hu, Ernesto Jimenez-Ruiz, Ole Magnus Holter, Denvar Antonyrajah, and Ian\nHorrocks. Owl2vec*: Embedding of o\n\n\n--- Page 13 ---\nA Hierarchy Construction from Ontologies\nThe Terminology Box (TBox) in an OWL (Web Ontology Language)12ontology defines entity\nrelationships using subsumption axioms ( C\u2291D) and equivalence axioms ( C\u2261D), where CandD\nareatomic orcomplex concept expressions defined in the description logic SROIQ . In this work,\nwe used atomic concepts as nodes of the hierarchy. We employed an ontology reasoner to deduce\ndirect13subsumptions and included these as edges in the hierarchy. This approach fully considers\nboth subsumption and equivalence axioms for all potential edges. Considering an atomic concept\nBeef , which is defined by Beef\u2261Meat\u2293 \u2203derivesFrom .Cattle , as an example, the reasoning will\nlead to an edge between Beef andMeat . Without reasoning, Beef will be misplaced under the root\nnode, if no other subsumptions about Beef are asserted in the ontology. Tools like Prot\u00e9g\u00e914also\ndemonstrate similar considerations in presenting ontology concept taxonomies.\nIt is also important to note the variability in naming schemes across different ontologies, which\nsometimes necessitates pre-processing of entity names. [ 6] provided detailed pre-processing steps for\nSchema.org, FoodOn, and DOID. In this study, we used the pre-processed versions of FoodOn and\nDOID and applied the same pre-processing methodology to the latest version of Schema.org.\nB Experiment Settings\nThe code implementation of this work primarily depends on DeepOnto [34] for processing hierar-\nchies and constructing datasets, Ge\n\n\n--- Page 14 ---\nwas adopted in training Poincar\u00e9Embed [12]. Our trial experiments demonstrated that the triplet\nform converges more efficiently and effectively compared to these alternatives.\nLoss Margins We provide an ablation study on loss margins \u03b1and\u03b2defined in Equation (3)and\nEquation (4), respectively.\nTable 6: Ablation results (F-score) of allMiniLM-L12-v2 +HITon WordNet\u2019s Mixed-hop Prediction.\n\u03b1= 5.0, \u03b2= 0.1 \u03b1= 3.0, \u03b2= 0.1 \u03b1= 1.0, \u03b2= 0.1 \u03b1= 5.0, \u03b2= 0.5\n0.885 0.865 0.867 0.899\nThe results from Table 6 indicate that although loss margins impact performance, the HITmodel\nexhibits robustness to their variations. Notably, a higher F-score for \u03b1= 5.0, \u03b2= 0.5is observed,\nsurpassing the results presented in the main paper. Despite this, we chose not to overly optimise \u03b1\nand\u03b2to avoid overfitting and to maintain the generalisability of our findings.\nD Results on SNOMED CT\nIn the main paper, we primarily focused on models trained on the WordNet (Noun). This section\nbroadens our study to encompass models trained on SNOMED CT [ 15], a structured, comprehensive,\nand widely-used vocabulary for electronic health records. Using the tool provided by the SNOMED\nCT team,16we converted the latest version of SNOMED CT (released in December 2023) into the\nOWL ontology format. We then constructed the hierarchy according to the procedure detailed in\nAppendix A.\nFor entity name pre-processing in SNOMED CT, we addressed potential information leakage during\ntesting. Typically, an SNOMED CT entity is named in th\n\n\n--- Page 15 ---\nTable 8: Mixed-hop Prediction test results on SNOMED and Transfer Mixed-hop Prediction results\non Schema.org, FoodOn, and DOID.\nRandom Negatives Hard Negatives\nModel Precision Recall F-score Precision Recall F-score\nMajorityPrior 0.091 0.091 0.091 0.091 0.091 0.091\nMixed-hop Prediction (SNOMED)\nall-MiniLM-L12-v2 0.224 0.443 0.297 0.145 0.398 0.213\n+ fine-tune 0.919 0.859 0.888 0.894 0.635 0.743\n+ H IT 0.941 0.967 0.954 0.905 0.894 0.899\nTransfer Mixed-hop Prediction (SNOMED \u2192Schema.org)\nall-MiniLM-L12-v2 0.312 0.524 0.391 0.248 0.494 0.330\n+ fine-tune 0.198 0.864 0.322 0.431 0.288 0.345\n+ H IT 0.432 0.580 0.495 0.274 0.608 0.378\nTransfer Mixed-hop Prediction (SNOMED \u2192FoodOn)\nall-MiniLM-L12-v2 0.135 0.656 0.224 0.099 0.833 0.176\n+ fine-tune 0.378 0.540 0.445 0.638 0.371 0.469\n+ H IT 0.700 0.500 0.583 0.594 0.442 0.506\nTransfer Mixed-hop Prediction (SNOMED \u2192DOID)\nall-MiniLM-L12-v2 0.342 0.451 0.389 0.159 0.455 0.235\n+ fine-tune 0.547 0.912 0.684 0.831 0.795 0.812\n+ H IT 0.836 0.864 0.850 0.739 0.748 0.744\npre-trained version on Schema.org, suggesting an overfitting to biomedical domain knowledge in\nSNOMED CT. In contrast, H IT demonstrates greater robustness against such overfitting.\n15\n[Jupyter current working directory: /workspace/benchmark/datasets]\n[Jupyter Python interpreter: /openhands/poetry/openhands-ai-5O4_aCHf-py3.12/bin/python]", "extras": {"code": "# Print all available pages to find the loss function details\nnum_pages = len(reader.pages)\nprint('Total pages:', num_pages)\nfor i in range(num_pages):\n    print(f'--- Page {i+1} ---')\n    print(reader.pages[i].extract_text()[:1500])\n    print('\\n')"}, "success": true}, {"id": 24, "timestamp": "2025-05-19T19:16:11.650834", "source": "agent", "message": "Reading file: /workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "action": "read", "tool_call_metadata": {"function_name": "str_replace_editor", "tool_call_id": "call_CU4VAAmfsnBfiBLN5AVpocE6", "model_response": {"id": "chatcmpl-BZ4wMUnO1Ei8AUoWiCXywYpcFvypg", "created": 1747700170, "model": "gpt-4.1-2025-04-14", "object": "chat.completion", "system_fingerprint": "fp_ccc6ec921d", "choices": [{"finish_reason": "tool_calls", "index": 0, "message": {"content": null, "role": "assistant", "tool_calls": [{"function": {"arguments": "{\"command\":\"view\",\"path\":\"/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py\",\"view_range\":[61,100]}", "name": "str_replace_editor"}, "id": "call_CU4VAAmfsnBfiBLN5AVpocE6", "type": "function"}], "function_call": null, "annotations": []}}], "usage": {"completion_tokens": 52, "prompt_tokens": 14629, "total_tokens": 14681, "completion_tokens_details": {"accepted_prediction_tokens": 0, "audio_tokens": 0, "reasoning_tokens": 0, "rejected_prediction_tokens": 0}, "prompt_tokens_details": {"audio_tokens": 0, "cached_tokens": 8064}}, "service_tier": "default"}, "total_calls_in_response": 1}, "llm_metrics": {"accumulated_cost": 0.06596799999999998, "accumulated_token_usage": {"model": "gpt-4.1-2025-04-14", "prompt_tokens": 74820, "completion_tokens": 629, "cache_read_tokens": 59136, "cache_write_tokens": 0, "response_id": ""}, "costs": [], "response_latencies": [], "token_usages": []}, "args": {"path": "/workspace/benchmark/datasets/2-HITs/HierarchyTransformers/src/hierarchy_transformers/losses/hit_loss.py", "start": 0, "end": -1, "thought": "", "impl_source": "oh_aci", "view_range": [61, 100]}}]